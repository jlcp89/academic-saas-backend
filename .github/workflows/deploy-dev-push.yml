name: Deploy Backend to DEV (Push)

on:
  push:
    branches: [ dev ]

env:
  AWS_REGION: us-east-1

jobs:
  deploy-dev:
    name: Deploy to DEV Environment
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Deploy Django Backend to EC2 (dev)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "🚀 Iniciando despliegue del backend..."
            
            # Configurar variables de entorno
            export ENVIRONMENT=dev
            export DATABASE_URL=${{ secrets.DATABASE_URL_DEV }}
            export REDIS_URL=${{ secrets.REDIS_URL_DEV }}
            export SECRET_KEY=${{ secrets.SECRET_KEY_DEV }}
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME_DEV }}
            
            cd /home/ec2-user
            echo "🧹 Limpiando despliegue anterior..."
            sudo rm -rf academic_saas
            
            echo "📥 Clonando repositorio backend..."
            git clone --depth 1 --branch dev https://github.com/jlcp89/academic_saas.git academic_saas
            
            cd academic_saas
            
            echo "🐍 Configurando Python y Poetry..."
            # Install Poetry if not present
            if ! command -v poetry &> /dev/null; then
              echo "Instalando Poetry..."
              curl -sSL https://install.python-poetry.org | python3 -
              echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
              source ~/.bashrc
              export PATH="$HOME/.local/bin:$PATH"
              
              # Verify installation
              if ! command -v poetry &> /dev/null; then
                echo "Poetry installation failed, trying alternative method..."
                pip3 install poetry
                export PATH="$HOME/.local/bin:$PATH"
              fi
            fi
            
            # Ensure Poetry is in PATH
            export PATH="$HOME/.local/bin:$PATH"
            poetry --version
            
            echo "📦 Instalando dependencias..."
            poetry install --only=main --no-dev
            
            echo "🛑 Deteniendo servicio existente..."
            sudo pkill -f "python.*manage.py.*runserver" || true
            sudo pkill -f "gunicorn.*core.wsgi" || true
            
            echo "⚙️ Configurando variables de entorno..."
            cat > .env << EOF
            ENVIRONMENT=dev
            DATABASE_URL=${{ secrets.DATABASE_URL_DEV }}
            REDIS_URL=${{ secrets.REDIS_URL_DEV }}
            SECRET_KEY=${{ secrets.SECRET_KEY_DEV }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME_DEV }}
            DEBUG=True
            ALLOWED_HOSTS=localhost,127.0.0.1,${{ secrets.EC2_HOST_DEV }}
            CORS_ALLOWED_ORIGINS=http://localhost:3000,http://${{ secrets.EC2_HOST_DEV }}:3000,http://${{ secrets.EC2_HOST_DEV }}
            EOF
            
            echo "🔄 Ejecutando migraciones..."
            poetry run python manage.py migrate
            
            echo "📁 Recolectando archivos estáticos..."
            poetry run python manage.py collectstatic --noinput
            
            echo "🚀 Iniciando servidor Django..."
            nohup poetry run gunicorn --bind 0.0.0.0:8000 --workers 2 --daemon --pid /tmp/django.pid core.wsgi:application
            
            echo "⏳ Esperando que el servicio esté listo..."
            sleep 15
            
            echo "🔍 Verificando salud del servicio..."
            # Verificar que esté funcionando
            if curl -f http://localhost:8000/admin/login/ > /dev/null 2>&1; then
              echo "✅ Backend desplegado exitosamente!"
              echo "🌐 URL: http://${{ secrets.EC2_HOST_DEV }}:8000"
              echo "🔧 Admin: http://${{ secrets.EC2_HOST_DEV }}:8000/admin"
            else
              echo "❌ Error: El backend no responde"
              echo "Logs del proceso:"
              tail -n 50 nohup.out || echo "No hay logs disponibles"
              exit 1
            fi

      - name: Verify deployment
        run: |
          echo "🔍 Verificando despliegue del backend..."
          sleep 10
          curl -f http://${{ secrets.EC2_HOST_DEV }}:8000/admin/login/ || exit 1
          echo "✅ Verificación del backend completada exitosamente!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "🎉 Backend deployment successful!"
            echo "✅ Application is live and healthy"
            echo "🌐 API URL: http://${{ secrets.EC2_HOST_DEV }}:8000"
            echo "🔧 Admin URL: http://${{ secrets.EC2_HOST_DEV }}:8000/admin"
          else
            echo "❌ Backend deployment failed!"
            echo "🔍 Check the logs above for more details"
          fi 