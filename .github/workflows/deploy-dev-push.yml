name: Deploy Backend to DEV (Push)

on:
  push:
    branches: [ dev ]

env:
  AWS_REGION: us-east-1

jobs:
  deploy-dev:
    name: Deploy to DEV Environment
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Deploy Django Backend to EC2 (dev)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Iniciando despliegue del backend..."
            
            # Configurar variables de entorno
            export ENVIRONMENT=dev
            export DATABASE_URL=${{ secrets.DATABASE_URL_DEV }}
            export REDIS_URL=${{ secrets.REDIS_URL_DEV }}
            export SECRET_KEY=${{ secrets.SECRET_KEY_DEV }}
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME_DEV }}
            
            cd /home/ec2-user
            echo "ğŸ§¹ Limpiando despliegue anterior..."
            sudo rm -rf academic-saas-backend
            
            echo "ğŸ“¥ Clonando repositorio backend..."
            git clone --depth 1 --branch dev https://github.com/jlcp89/academic-saas-backend.git academic-saas-backend
            
            cd academic-saas-backend
            
            echo "ğŸ Configurando Python y dependencias..."
            
            # Install Python 3.8 if not present
            if ! command -v python3.8 &> /dev/null; then
              echo "Installing Python 3.8..."
              sudo yum update -y
              sudo yum install -y amazon-linux-extras
              sudo amazon-linux-extras enable python3.8
              sudo yum install -y python3.8 python3.8-pip
            fi
            
            echo "Using Python 3.8..."
            python3.8 --version
            
            # Install Python dependencies (skip if already installed recently)
            echo "ğŸ“¦ Instalando dependencias..."
            python3.8 -m pip install -r requirements.txt --quiet
            
            echo "ğŸ›‘ Verificando y deteniendo servicios existentes..."
            # Check if Django is running and stop it gracefully
            if [ -f /tmp/django.pid ]; then
              OLD_PID=$(cat /tmp/django.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                echo "Terminando proceso Django PID: $OLD_PID"
                kill $OLD_PID || true
                sleep 3
                # Force kill if still running
                kill -9 $OLD_PID 2>/dev/null || true
              fi
              rm -f /tmp/django.pid
            fi
            
            echo "âš™ï¸ Configurando variables de entorno..."
            
            # Generate a fallback SECRET_KEY if the secret is empty
            SECRET_KEY_VALUE="${{ secrets.SECRET_KEY_DEV }}"
            if [ -z "$SECRET_KEY_VALUE" ]; then
              echo "âš ï¸ SECRET_KEY_DEV not configured, generating temporary key"
              SECRET_KEY_VALUE="dev-temp-key-$(date +%s)-$(openssl rand -hex 32)"
            fi
            
            cat > .env << EOF
            ENVIRONMENT=dev
            DATABASE_URL=sqlite:///db.sqlite3
            SECRET_KEY=$SECRET_KEY_VALUE
            DEBUG=True
            ALLOWED_HOSTS=localhost,127.0.0.1,${{ secrets.EC2_HOST_DEV }}
            CORS_ALLOWED_ORIGINS=http://localhost:3000,http://${{ secrets.EC2_HOST_DEV }}:3000,http://${{ secrets.EC2_HOST_DEV }}
            EOF
            
            echo "âœ… Variables de entorno configuradas"
            
            echo "ğŸ”„ Ejecutando migraciones..."
            python3.8 manage.py migrate || { echo "Migration failed"; exit 1; }
            
            echo "ğŸ“ Recolectando archivos estÃ¡ticos..."
            python3.8 manage.py collectstatic --noinput || { echo "Collectstatic failed"; exit 1; }
            
            echo "ğŸš€ Iniciando servidor Django..."
            nohup python3.8 -m gunicorn --bind 0.0.0.0:8000 --workers 2 --pid /tmp/django.pid core.wsgi:application > /tmp/django.log 2>&1 &
            
            echo "â³ Esperando que el servicio estÃ© listo..."
            sleep 10
            
            # Check if process started
            if [ -f /tmp/django.pid ]; then
              echo "âœ… Django PID file created: $(cat /tmp/django.pid)"
            else
              echo "âŒ Django PID file not found"
            fi
            
            echo "ğŸ” Verificando salud del servicio..."
            # Wait a bit more and check
            sleep 5
            
            # Check if service is responding
            for i in {1..5}; do
              if curl -f http://localhost:8000/admin/login/ > /dev/null 2>&1; then
                echo "âœ… Backend desplegado exitosamente!"
                echo "ğŸŒ URL: http://${{ secrets.EC2_HOST_DEV }}:8000"
                echo "ğŸ”§ Admin: http://${{ secrets.EC2_HOST_DEV }}:8000/admin"
                exit 0
              else
                echo "Intento $i/5: Esperando respuesta del servidor..."
                sleep 3
              fi
            done
            
            echo "âŒ Error: El backend no responde despuÃ©s de varios intentos"
            echo "Logs del proceso:"
            tail -n 50 /tmp/django.log || echo "No hay logs disponibles en /tmp/django.log"
            ps aux | grep gunicorn || echo "No hay procesos gunicorn"
            exit 1

      - name: Verify deployment
        run: |
          echo "ğŸ” Verificando despliegue del backend..."
          sleep 10
          curl -f http://${{ secrets.EC2_HOST_DEV }}:8000/admin/login/ || exit 1
          echo "âœ… VerificaciÃ³n del backend completada exitosamente!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Backend deployment successful!"
            echo "âœ… Application is live and healthy"
            echo "ğŸŒ API URL: http://${{ secrets.EC2_HOST_DEV }}:8000"
            echo "ğŸ”§ Admin URL: http://${{ secrets.EC2_HOST_DEV }}:8000/admin"
          else
            echo "âŒ Backend deployment failed!"
            echo "ğŸ” Check the logs above for more details"
          fi 